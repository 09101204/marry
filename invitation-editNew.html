<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>婚礼纪</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" type="text/css" href="css/base.css">
    <link rel="stylesheet" type="text/css" href="css/global.css">
    <link rel="stylesheet" type="text/css" href="css/common.css">
    <link rel="stylesheet" type="text/css" href="css/module.css">
    <link rel="stylesheet" type="text/css" href="css/status.css">
    <script src="js/sea-modules/seajs/1.3.1/sea.js" type="text/javascript"></script>
    <script src="http://libs.baidu.com/jquery/1.9.0/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="js/application.js"></script>
    <!--[if lt IE 9]>
    <script type="text/javascript" src="js/dist/html5shiv.js"></script>
    <![endif]-->
</head>
<body>
<div id="wrapper">
<nav id="topBar" class="ui-top-nav">
</nav>
    <script type="text/javascript">
        seajs.use(['marry/application'], function(App) {
            var template=new App.template();
            template.loadHeader("#indexUrl");
        });
    </script>

    <div id="container" class="container">
        <form class="ui-form" action="#" post="#">
        <input type="hidden" name="token" value="" id="token"/>
        <input type="hidden" name="secret" value="" id="secret"/>
        <input type="hidden" name="card[user_id]" id="userId">
        <input type="hidden" name="card[theme_id]" id="templateId">
        <input type="text" class="fn-hide"  id="fileIndex" value="1">
        <section id="firstStep" >
            <div class="add-panel ui-shadow">
                <header>
                    <div class="icons">
                        <i class="icon icon-active"></i>
                        <i class="dot"></i>
                        <i class="icon"></i>
                        <i class="dot"></i>
                        <i class="icon"></i>
                    </div>
                    <div class="step"> 1</div>
                </header>
                <section class="invitation-panel clearfix">
                    <div class="invitation-form">
                        <fieldset>
                            <legend>创建请帖</legend>
                            <div class="form-item">
                                <label class="label">你的身份:</label>
                                <input class="ui-radio" type="radio" name="sex" checked value="groom"/>
                                <span class="ui-radio-txt"> 新郎</span>
                                <input class="ui-radio" type="radio" name="sex" value="bride"/>
                                <span class="ui-radio-txt"> 新娘</span>
                            </div>
                            <div class="form-item">
                                <label for="yourName" class="label">你的名字:</label>
                                <input class="input" type="text" id="yourName" name="card[groom_name]"/>
                            </div>
                            <div class="form-item">
                                <label for="halfName" class="label">Ta的名字:</label>
                                <input class="input" type="text" id="halfName" name="card[bride_name]"/>
                            </div>
                            <div class="form-item">
                                <label for="marryTime" class="label">婚礼时间:</label>
                                <input class="input" id="marryTime" type="text" onClick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm'})"/>
                            </div>
                            <div class="form-item form-item-error position-panel">
                                <label for="place" class="label">婚礼地址:</label>
                                <textarea id="place" name="card[place]" class="textarea"></textarea>
                                <span class="position-btn">定位</span>
                            </div>
                            <div class="form-item text-center">
                                <input type="file" name="file1" id="cover">
                                <div class="ui-btn middle ui-btn-green" id="uploadCover">
                                    <span  class="ui-btn-text">上传照片</span>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="iphone5">
                        <!--<div class="iphone5-inner">
                            <h3>请登录后进行操作</h3>
                            <div class="login ui-login-btn green">
                                <a id="qq" class="ui-login-btn-text qq" href="/"> <span>??</span> </a>
                                <a id="weibo" class="ui-login-btn-text sina" href="/"><span> ??</span> </a>
                            </div>
                        </div>-->
                        <div class="phone-layer" id="phoneLayer">
                            <img src="" id="coverImg" class="fn-hide info cover-img">
                            <div class="bg"><img src=""></div>
                            <div class="info" id="bride_info"></div>
                            <div class="info" id="groom_info"></div>
                            <div class="info" id="time_info"></div>
                            <div class="info" id="place_info"></div>
                        </div>
                    </div>
                    <div class="invitation-template">
                        <header>
                            <a class="ui-btn large gray fn-right">
                                <span href="#" class="ui-btn-text">购买套餐</span>
                            </a>
                            <h2>请帖模板</h2>
                        </header>
                        <section class="invitation-list clearfix ui-scrollbar">
                            <ul id="templatePanel">
                            </ul>
                        </section>
                        <script type="text/javascript">
                            seajs.use(['marry/application'], function(App) {
                                var invitation=new App.Invitation();
                                invitation.getTemplate({
                                    element:"#templatePanel"
                                });
                            });
                        </script>
                    </div>
                </section>

            </div>
            <div class="invitation-btn clearfix">
                <div class="ui-btn ui-btn-green large" id="1to2">
                    <span class="ui-btn-text"> 下一步 </span>
                </div>
            </div>
        </section>
        <section id="secondStep">
            <div class="add-panel ui-shadow">
                <header>
                    <h2 class="title">请帖相册</h2>
                    <div class="icons">
                        <i class="icon icon-active"></i>
                        <i class="dot"></i>
                        <i class="icon"></i>
                        <i class="dot"></i>
                        <i class="icon"></i>
                    </div>
                    <div class="step"> 2</div>
                    <div class="upload-panel">
                        <div class="ui-btn middle ui-btn-green fn-right video">
                            <span class="ui-btn-text"> 上传视频 </span>
                        </div>
                        <div class="ui-btn middle ui-btn-green fn-right photo" id="uploadPhoto">
                            <span class="ui-btn-text"> 上传照片 </span>
                        </div>
                        <!--<span class="txt">按“ctrl”可多选</span>-->
                    </div>
                </header>
                <section class="add-list clearfix" id="2ndPanel">
                    <article id="uploadList_1" class="note add-list-item fn-hide">
                        <div class="close" title="删除" data-index="0">X</div>
                        <div class="cover">
                            <img id="uploadImage_1" src=""/>
                            <input type="file" name="image_file1" id="file1"/>
                        </div>
                    </article>
                </section>
                <footer class="foot-txt upload-info">
        <span>
          视频<span id="videoNum">0</span>/1
        </span>
        <span class="ml30">
          照片<span id="photoNum">0</span>/15
        </span>
                </footer>
            </div>
            <div class="clearfix text-center">
                <div class="ui-btn ui-btn-green large">
                    <span class="ui-btn-text"> 上一步 </span>
                </div>

                <div class="ui-btn gray large ml30" id="2to3">
                    <span class="ui-btn-text"> 下一步 </span>
                </div>
            </div>
        </section>
        <section id="thirdStep">
            <div class="add-panel ui-shadow">
                <header>
                    <div class="icons">
                        <i class="icon "></i>
                        <i class="dot"></i>
                        <i class="icon"></i>
                        <i class="dot"></i>
                        <i class="icon icon-active"></i>
                    </div>
                    <div class="step"> 3</div>
                </header>
                <section class="invitation-panel third-step clearfix">
                    <div class="iphone5">
                        <div class="screen-inner">
                        </div>
                    </div>
                    <div class="weixin-panel">
                        <h2>邀请二维码:<span>（未安装应用也可查看请帖)</span></h2>
                        <div class="wx-wrap">

                            <div class="sl-hvalign">
                                <div class="sl-hvalign-cnt">
                                    <div class="sl-hvalign-cnt-inner">
                                        <div style="width: 260px;">
                                            <img src="assets/images/weixin.jpg">
                                            <div class="download-btn">
                                                <a href="#" class="download-btn-txt">下载</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div> <!-- .sl-hvalign -->
                        </div>
                        <h2>邀请字符码:<span class="code">X3SP3O</span></h2>
                        <div class="info">将邀请发送给你的亲朋好友，邀请他们来参加婚礼吧！</div>
                        <div class="app">
                            <h2>应用下载</h2>
                            <div class="ui-download-btn">
                                <a href="/" class="iphone" target="_blank">iphone</a>
                                <a href="/" class="android" target="_blank">android</a>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <div class="clearfix invitation-btn">
                <div class="ui-btn ui-btn-green large" id="3to2">
                    <span class="ui-btn-text"> 上一步 </span>
                </div>
                <div class="ui-btn ui-btn-green large ml30">
                    <input type="submit" class="ui-btn-text" value="完成"/>
                </div>
            </div>
        </section>
        </form>
</div>
    <footer class="ui-footer ui-shadow-top" id="foot"></footer>
    <script type="text/javascript">
        seajs.use(['marry/application'], function(App) {
            var template=new App.template();
            template.loadFoot();
        });
    </script>
</div>
<script type="text/javascript" src="js/dist/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="js/dist/chinese-lunar.js"></script>
<script type="text/javascript">
seajs.config({
    alias: {
        "$": "gallery/jquery.js"
    },
    locale: 'zh-cn',
    preload: 'seajs/plugin-i18n'
});
    var params = {
        fileInput: $("#file1").get(0),
        addPanel:'#2ndPanel'
    };

    var photoUploader= $.extend(photoUpload, params);
    photoUploader.init();

    $("#uploadPhoto").click(function(){
        var index=parseInt($("#fileIndex").val());
        $("#file"+index).click();
    });

    var formWidget={
        init:function(){
            this.chooseSex();
        },
        chooseSex:function(){
            $("input[name='sex']").on("click",function(){
                var sex= $("input:radio[name='sex']:checked").val();
                if(sex==="groom"){
                    $("#yourName").attr("name","groom_name");
                    $("#halfName").attr("name","bride_name");
                }else{
                    $("#yourName").attr("name","bride_name");
                    $("#halfName").attr("name","groom_name");
                }
            })
        },
        validate:function(){

        }
    }
    formWidget.init();
    var templateWidget={
        init:function(){
            this.chooseTemplate();
        },
        changeCover:function(e){
            var files = e.target.files || e.dataTransfer.files;
            if (files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $("#coverImg").attr("src",e.target.result).removeClass("fn-hide");
                }
                reader.readAsDataURL(files[0]);
            }
        },
        chooseTemplate:function(){
            var self=this;
            $(document).on("click", "#templatePanel>li",function(){
               var id=$(this).attr("data-id");
/*                Window.util.FlyJSONP.get({
                    url:"http://www.marrymemo.com/themes/"+id+".json",
                    success:function(data){
//                        console.log(data);
                        $("#phoneLayer").css({
                            "background":"http://www.marrymemo.com/ThemeBack/20130205152458.jpg"
                        })
                    }
                })*/

                var templates,temParam;
                 templates= self.cloneObject(window.temData);
                for(var i in templates){
                   if(id==templates[i].id){
                       temParam=templates[i];
                      break;
                   }
                }
                self.updateTemplate(temParam);

            });
        },
        updateTemplate:function(data){
            var self=this;
            if(!self.validate()) return alert("请输入完整的信息,^_^");
            $("#groom_info").text($("input[name='card[groom_name]']").val()).css(self.transStyle(data.groom_info));
            $("#bride_info").text($("input[name='card[bride_name]']").val()).css(self.transStyle(data.bride_info));
            $("#place_info").text($("#place").val()).css(self.transStyle(data.location_info));

            /*seajs.use(['marry/util','$'],function(Util,$) {
               var newdate=Util.lunar( $("#marryTime").val());
                $("#time_info").html(newdate)
            });*/
            var strDate= $("#marryTime").val();
            var inputDate=new Date(strDate.substr(0,10));
            var tranDate=chineseLunar.solarToLunar(inputDate);
            var newDate=tranDate.gongli+" "+strDate.substr(10)+"<br/>"+tranDate.nongli;
            $("#time_info").html(newDate).css(self.transStyle(data.time_info));
            var imgList=self.transImg(data.image_info);
            for(var i in imgList){
                $(".cover-img").eq(i).css(imgList[i]);
            }
            $("#phoneLayer .bg > img").attr("src","http://www.marrymemo.com"+data.background).parent().show();

        },
        validate:function(){
            return true;
        },
        parameter:{
           xAdjust:257/320,
           yAdjust:455/568
        },
        transStyle:function(data){
           var result=data;
            result.color="RGB("+data.color+")"
            result.left=(data.x)*this.parameter.xAdjust;
            result.top=(data.y)*this.parameter.yAdjust;
            result.fontSize=data.font;
            result.textAlign=(data.alignment===2?"center":"left");
            return result;
        },
        transImg:function(data){
           var result=data;
           for(var i= 0,len=data.length;i<len;i++){
               result[i].left=(result[i].x)*this.parameter.xAdjust;
               result[i].top=(result[i].y)*this.parameter.yAdjust;
               result[i].width=(result[i].width)*this.parameter.xAdjust;
            }
           console.log("the image is "+result[0].width);
           return result
        },
        cloneObject:function(obj){
            var o = obj.constructor === Array ? [] : {};
            for(var i in obj){
                if(obj.hasOwnProperty(i)){
                    o[i] = typeof obj[i] === "object" ? this.cloneObject(obj[i]) : obj[i];
                }
            }
            return o;

        }
    }
    templateWidget.init();
    var stepNav={
        init:function(){
            var self=this;
            $("#2to1").on("click",function(){
                if($(this).attr("data-next")==="true"){
                    self.goSecond();
                }else{
                    alert("请上传图片");
                }
            });
        },
        backFirst:function(){
            $("#firstStep").show();
            $("#secondStep").hide();
        },
        goSecond:function(){
            var self=this;
            $("#firstStep").hide();
            $("#secondStep").show();
            $("#2to1").on("click",self.backFirst);
//            self.formBlur();
            $("#2to3").on("click",function(){
                self.goThird();
            });

        },
        goThird:function(){
            var self=this;
            if($("#2ndPanel article").size()<2) return alert("请上传图片");

            $("#secondStep").hide();
            var photoList=$("#2ndPanelPanel article");
            for(var i=0;i<(photoList.size()-1);i++){
                photoList.eq(i).find("input[type='file']").attr("name","image_file"+(i+1));
            }
            $("#thirdStep").show();
            $("#3to2").click(function(){
                self.backSecond();
            });
            $("#createSubmit").on("click",self.submit);
        },
        backSecond:function(){
            $("#thirdStep").hide();
            $("#secondStep").show();
        },
        validate:function(){
            console.log("validate!!!");
            var name= $("#montageTitle").val(),description=$("#montageIntroduction").val();
            if(name===""||description===""){
                alert("请输入相关信息");
                return false;
            }
            return true;
        },
        formChange:function(){
            $("#secondStep input,#secondStep textarea").blur(function(){
                var name= $("#montageTitle").val(),description=$("#montageIntroduction").val();
                if(name!==""&&description!==""){
                    $("#2to3").removeClass("gray").addClass("ui-btn-green");
                }
            });
        },
        submit:function(){
            $("#hidden_frame").on("load complete",function(){
                var data=$(window.frames["hidden_frame"].document).find("pre").html();
                if(data.indexOf("ok")!==-1)
//                    var id=data.indexOf(":",data.length-10);
                    window.location.href=HOST+"/marry/montage-index.html";
            });
        }
    }
//    stepNav.init();
    $("#uploadCover").on("click",function(){
        document.getElementById("cover").addEventListener("change",function(e){templateWidget.changeCover(e)}, false);
        $("#cover").click();
    })

    seajs.use(['arale/validator/0.9.2/validator', 'gallery/jquery.js'], function(Validator, $) {
        $(function() {
            var validator = new Validator({
                element: 'form'
            });
            validator.addItem({
                element: '#place',
                required: true
            })
        });
    });
</script>
</body>
</html>
